<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CryoLoop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="color-scheme" content="dark light" />
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script defer src="app.js"></script>
  </head>
  <body>
    <header id="top-bar">
      <h1 class="brand">CryoLoop</h1>
      <div class="header-controls">
        <nav id="page-tabs" aria-label="View selection">
          <button type="button" class="page-tab active" data-page="general">General</button>
          <button type="button" class="page-tab" data-page="pump">Pump Control</button>
          <button type="button" class="page-tab" data-page="hx">Heat Exchanger</button>
          <button type="button" class="page-tab" data-page="fluids">Fluid Properties</button>
        </nav>
        <div class="logging-controls button-row">
          <button id="logging-toggle" class="primary">Start Logging</button>
        </div>
      </div>
    </header>

    <div id="status-strip">
      <span id="connection-status" class="status-chip sentence-case">Status: initializing…</span>
      <span id="logging-status" class="status-chip sentence-case">Logging: off</span>
      <span id="command-status" class="status-chip status-compact">Alert: none</span>
    </div>

    <main>
      <div class="page-panel active" id="page-general" data-page-panel="general">
        <section class="hero-card">
          <h2>System Overview</h2>
          <p>
            Welcome to the HFE operations console. Use this page for quick status checks, then dive
            into the Pump or Heat Exchanger panels for detailed control and telemetry.
          </p>
        </section>

        <section class="overview-grid">
          <article class="overview-card">
            <h3>Connection</h3>
            <p id="overview-connection" class="overview-value sentence-case">Initializing…</p>
            <p class="overview-hint">Reflects telemetry WebSocket state.</p>
          </article>
          <article class="overview-card">
            <h3>Pump Speed</h3>
            <p id="overview-pump-speed" class="overview-value">—</p>
            <p id="overview-pump-speed-sub" class="overview-subvalue muted">—</p>
            <p class="overview-hint">Displays the pump's frequency.</p>
          </article>
          <article class="overview-card">
            <h3>LN Valve</h3>
            <p id="overview-valve" class="overview-value sentence-case">—</p>
            <p class="overview-hint">Shows current LN valve mode and state.</p>
          </article>
          <article class="overview-card">
            <h3>Selected Average</h3>
            <p id="overview-avg-temp" class="overview-value">—</p>
            <p class="overview-hint">Average of sensors currently marked for control.</p>
          </article>
          <article class="overview-card">
            <h3>Tank Pressure</h3>
            <p id="overview-tank-pressure" class="overview-value">—</p>
            <p id="overview-tank-pressure-sub" class="overview-subvalue muted">(±0.05 bar)</p>
          </article>
        </section>

        <section id="chart-section">
          <canvas id="temp-chart" aria-label="Temperature chart"></canvas>
        </section>

        <section id="stats-section">
          <div class="stat-card">
            <h2>Sensors</h2>
            <p id="sensor-count">Active: —</p>
            <p id="valid-count">Valid now: —</p>
            <p id="valid-list" class="muted">Included sensors: —</p>
            <div id="sensor-values" class="sensor-values-grid">
              <p class="muted">No telemetry yet.</p>
            </div>
          </div>
        </section>
      </div>

      <div class="page-panel" id="page-pump" data-page-panel="pump">
        <section class="hero-card">
          <h2>Pump Control</h2>
          <p>
            Set the analog command for the circulation pump and watch live drive telemetry. Commands map 0–100% to 0–71.7 Hz (≈2150 rpm, ≈4.0 L/min HFE). Run/Stop remains controlled on the VFD keypad for safety.
          </p>
        </section>

        <section class="pump-section">
          <div class="stat-card">
            <h2>Pump Command</h2>
            <form id="pump-command-form">
              <div class="pump-command-layout">
                <div class="pump-control-col">
                  <p id="pump-run-state" class="pump-state valve-closed sentence-case">Stopped</p>
                  <label class="slider-label pump-slider-row">
                    Target (% of max)
                    <input type="range" id="pump-command-slider" min="0" max="100" step="0.1" value="0" />
                  </label>
                  <div class="pump-input-row">
                    <label class="number-label" aria-label="Target (%)">
                      <input type="number" id="pump-command-input" min="0" max="100" step="0.1" inputmode="decimal" value="0" />
                    </label>
                    <label class="overspeed-toggle">
                      <input type="checkbox" id="pump-overspeed-toggle" />
                      <span>Allow overspeed (&gt;60 Hz)</span>
                    </label>
                  </div>
                  <div class="form-actions pump-form-actions">
                    <button type="submit" class="primary half-width">Set Speed</button>
                    <button type="button" id="pump-stop-button" class="danger half-width">Stop</button>
                  </div>
                </div>
                <div class="pump-status-col">
                  <div class="pump-pill">
                    <span class="pill-label">Commanded</span>
                    <span id="pump-cmd-hz">—</span>
                    <span class="pill-sub">Analog output setpoint (Hz)</span>
                  </div>
                  <div class="pump-pill">
                    <span class="pill-label">Est. RPM / Flow</span>
                    <span id="pump-cmd-rpm">—</span>
                    <span id="pump-cmd-flow" class="pill-sub">—</span>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </section>

        <section class="pump-section">
          <div class="stat-card">
            <h2>VFD Monitors</h2>
              <div class="metric-grid vfd-grid">
              <div class="metric-block power-block">
                <span class="metric-label">Input Power</span>
                <span id="vfd-power" class="metric-value">—</span>
                <span id="vfd-power-pct" class="metric-subvalue">—</span>
                <span id="vfd-power-unit" class="metric-unit">W</span>
              </div>
              <div class="metric-grid metrics-three vfd-output-grid">
                <div class="metric-block">
                  <span class="metric-label">Output Frequency</span>
                  <span id="vfd-frequency" class="metric-value">—</span>
                  <span id="vfd-frequency-pct" class="metric-subvalue">—</span>
                  <span id="vfd-frequency-unit" class="metric-unit">Hz</span>
                </div>
                <div class="metric-block">
                  <span class="metric-label">Output Current</span>
                  <span id="vfd-current" class="metric-value">—</span>
                  <span id="vfd-current-pct" class="metric-subvalue">—</span>
                  <span id="vfd-current-unit" class="metric-unit">A</span>
                </div>
                <div class="metric-block">
                  <span class="metric-label">Output Voltage</span>
                  <span id="vfd-voltage" class="metric-value">—</span>
                  <span id="vfd-voltage-pct" class="metric-subvalue">—</span>
                  <span id="vfd-voltage-unit" class="metric-unit">V</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="pump-section">
          <div class="stat-card">
            <h2>Loop Pressures</h2>
            <div class="metric-grid metrics-two">
              <div class="metric-block">
                <span class="metric-label">Before Pump</span>
                <span id="pump-pressure-before" class="metric-value">—</span>
                <span id="pump-pressure-before-unit" class="metric-unit">(±0.05 bar)</span>
              </div>
              <div class="metric-block">
                <span class="metric-label">After Pump</span>
                <span id="pump-pressure-after" class="metric-value">—</span>
                <span id="pump-pressure-after-unit" class="metric-unit">(±0.05 bar)</span>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="page-panel" id="page-hx" data-page-panel="hx">
        <section class="hero-card">
          <h2>Heat Exchanger</h2>
          <p>
            Control the LN valve, heaters, and temperature targets for the heat exchanger from this tab.
          </p>
        </section>

        <section class="stats-section hx-stats">
          <div class="stat-card">
            <h2>LN Valve</h2>
            <p id="valve-state" class="valve-closed sentence-case">Closed</p>
            <p id="mode-state">Mode: —</p>
            <div class="button-row compact">
              <button data-cmd="VALVE OPEN" class="primary">Open</button>
              <button data-cmd="VALVE CLOSE" class="primary">Close</button>
              <button data-cmd="VALVE AUTO">Auto</button>
            </div>
          </div>
          <div class="stat-card">
            <h2>Average (selected)</h2>
            <p id="avg-temp">—</p>
            <div id="sensor-selection" class="avg-selection">
              <p class="muted">Sensors included in average:</p>
              <div id="sensor-checkboxes" class="chip-grid">
                <p class="muted">Awaiting telemetry…</p>
              </div>
            </div>
          </div>
        </section>

        <section id="controls-section" class="controls-section hx-controls">
          <div class="control-group">
            <h2>Control Targets</h2>
            <form id="setpoint-form" class="form-row">
              <label>
                Setpoint (°C)
                <input type="number" id="setpoint-input" step="0.1" inputmode="decimal" value="25.0" />
                <span class="form-hint">Desired temperature the controller tries to maintain.</span>
              </label>
              <label>
                Hysteresis (°C)
                <input type="number" id="hysteresis-input" step="0.1" inputmode="decimal" value="0.5" />
                <span class="form-hint">Temperature band around the setpoint before the valve flips.</span>
              </label>
              <label>
                Telemetry interval (ms)
                <input type="number" id="telemetry-input" step="100" inputmode="numeric" value="1000" />
                <span class="form-hint">How often the controller sends telemetry (in milliseconds).</span>
              </label>
              <div class="form-actions">
                <button type="submit" class="primary">Apply</button>
              </div>
            </form>
          </div>
          <div class="control-group">
            <h2>Heaters</h2>
            <div class="metric-grid metrics-two">
              <div class="metric-block">
                <span class="metric-label">Bottom heater</span>
                <span id="heater-bottom-state" class="heater-state valve-closed">—</span>
                <div class="button-row compact">
                  <button data-cmd="HEATER BOTTOM ON" class="primary">On</button>
                  <button data-cmd="HEATER BOTTOM OFF">Off</button>
                </div>
              </div>
              <div class="metric-block">
                <span class="metric-label">LN exhaust heater</span>
                <span id="heater-exhaust-state" class="heater-state valve-closed">—</span>
                <div class="button-row compact">
                  <button data-cmd="HEATER EXHAUST ON" class="primary">On</button>
                  <button data-cmd="HEATER EXHAUST OFF">Off</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="page-panel" id="page-fluids" data-page-panel="fluids">
        <section class="hero-card">
          <h2>Fluid Properties</h2>
          <p>
            Track cryogenic fluid behavior here. Once telemetry is available, these metrics will populate automatically.
          </p>
        </section>

        <section class="stats-section">
          <div class="stat-card">
            <h2>Temperature Increase</h2>
            <p id="fluid-temp-rise" class="muted">Awaiting telemetry…</p>
          </div>
          <div class="stat-card">
            <h2>Mass Flow Rate</h2>
            <p id="fluid-mass-flow" class="muted">Awaiting telemetry…</p>
          </div>
          <div class="stat-card">
            <h2>Density</h2>
            <p id="fluid-density" class="muted">Awaiting telemetry…</p>
          </div>
          <div class="stat-card">
            <h2>Viscosity</h2>
            <p id="fluid-viscosity" class="muted">Awaiting telemetry…</p>
          </div>
          <div class="stat-card">
            <h2>Mixing Efficiency</h2>
            <p id="fluid-mixing-efficiency" class="muted">Awaiting telemetry…</p>
          </div>
        </section>
      </div>
    </main>
  </body>
</html>
